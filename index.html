<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinehurst QC Inspector</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <link rel="icon" href="icon-192x192.png" type="image/png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-box {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .auth-header p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-button:hover {
            background: #5a67d8;
        }

        .auth-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1rem;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .error-message {
            background: #fee;
            color: #c53030;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #feb2b2;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
        }

        .sync-indicator.syncing {
            background: #f39c12;
            animation: pulse 1s infinite;
        }

        .sync-indicator.offline {
            background: #e74c3c;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .settings-btn {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Navigation */
        .nav-container {
            background: #34495e;
            padding: 0;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
        }

        .nav-tab button {
            width: 100%;
            padding: 1rem 0.5rem;
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav-tab button.active {
            color: white;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        /* Content */
        .content {
            flex: 1;
            overflow-y: auto;
        }

        .section {
            display: none;
            padding: 1.5rem;
        }

        .section.active {
            display: block;
        }

        /* Forms */
        .form-section {
            margin-bottom: 2rem;
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .form-row label {
            min-width: 120px;
            font-weight: 500;
            color: #34495e;
            font-size: 0.9rem;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-row textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: calc(50% - 0.5rem);
        }

        .checkbox-item input[type="checkbox"] {
            flex: none;
            width: auto;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* History */
        .history-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .inspection-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .inspection-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #e0e6ed;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inspection-header:hover {
            background: #e9ecef;
        }

        .inspection-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .inspection-date {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .inspection-details {
            display: none;
            padding: 1rem;
            background: white;
        }

        .inspection-details.show {
            display: block;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h4 {
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .detail-label {
            font-weight: 500;
            color: #495057;
        }

        .detail-value {
            color: #6c757d;
        }

        .issues-list {
            list-style: none;
            margin-top: 0.5rem;
        }

        .issues-list li {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #856404;
        }

        .no-history {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .no-history .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Settings Screen */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .settings-overlay.show {
            display: block;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 400px;
            height: 100%;
            background: white;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-overlay.show .settings-panel {
            right: 0;
        }

        .settings-header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-settings {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .settings-content {
            padding: 1.5rem;
        }

        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .user-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .user-email {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .user-status {
            font-size: 0.8rem;
            color: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #7f8c8d;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }

            .auth-container {
                padding: 1rem;
            }

            .form-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .form-row label {
                min-width: auto;
            }

            .checkbox-item {
                min-width: 100%;
            }

            .detail-grid {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1>Pinehurst QC Inspector</h1>
                <p>Professional Quality Control System</p>
            </div>

            <div id="authError" class="error-message hidden"></div>

            <form id="authForm" class="auth-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>

                <button type="submit" class="auth-button" id="authSubmit">
                    <span id="authButtonText">Sign In</span>
                </button>
            </form>

            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <button type="button" id="authToggleBtn">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <header class="header">
            <h1>Pinehurst QC Inspector</h1>
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatus">Connected</span>
            </div>
            <button class="settings-btn" onclick="showSettings()">⚙️</button>
        </header>

        <nav class="nav-container">
            <ul class="nav-tabs">
                <li class="nav-tab">
                    <button onclick="showSection('inspection')" id="inspectionTab" class="active">New Inspection</button>
                </li>
                <li class="nav-tab">
                    <button onclick="showSection('history')" id="historyTab">History</button>
                </li>
            </ul>
        </nav>

        <main class="content">
            <!-- Inspection Section -->
            <section id="inspectionSection" class="section active">
                <form id="inspectionForm">
                    <div class="form-section">
                        <h3>🏢 Property Information</h3>
                        <div class="form-row">
                            <label for="propertyAddress">Address:</label>
                            <input type="text" id="propertyAddress" required>
                        </div>
                        <div class="form-row">
                            <label for="unitNumber">Unit Number:</label>
                            <input type="text" id="unitNumber">
                        </div>
                        <div class="form-row">
                            <label for="inspectionType">Type:</label>
                            <select id="inspectionType" required>
                                <option value="">Select Type</option>
                                <option value="move-in">Move-in Inspection</option>
                                <option value="move-out">Move-out Inspection</option>
                                <option value="periodic">Periodic Inspection</option>
                                <option value="maintenance">Post-Maintenance</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>👤 Inspector Details</h3>
                        <div class="form-row">
                            <label for="inspectorName">Inspector:</label>
                            <input type="text" id="inspectorName" required>
                        </div>
                        <div class="form-row">
                            <label for="inspectionDate">Date:</label>
                            <input type="date" id="inspectionDate" required>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>🏠 Room Conditions</h3>
                        <div class="checkbox-group" id="roomConditions">
                            <div class="checkbox-item">
                                <input type="checkbox" id="living_room" name="rooms" value="living_room">
                                <label for="living_room">Living Room</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="kitchen" name="rooms" value="kitchen">
                                <label for="kitchen">Kitchen</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="bedroom1" name="rooms" value="bedroom1">
                                <label for="bedroom1">Bedroom 1</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="bedroom2" name="rooms" value="bedroom2">
                                <label for="bedroom2">Bedroom 2</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="bathroom" name="rooms" value="bathroom">
                                <label for="bathroom">Bathroom</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="laundry" name="rooms" value="laundry">
                                <label for="laundry">Laundry</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>⚠️ Issues Found</h3>
                        <div class="checkbox-group" id="issuesFound">
                            <div class="checkbox-item">
                                <input type="checkbox" id="wall_damage" name="issues" value="wall_damage">
                                <label for="wall_damage">Wall Damage</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="carpet_stains" name="issues" value="carpet_stains">
                                <label for="carpet_stains">Carpet Stains</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="appliance_issues" name="issues" value="appliance_issues">
                                <label for="appliance_issues">Appliance Issues</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="plumbing_problems" name="issues" value="plumbing_problems">
                                <label for="plumbing_problems">Plumbing Problems</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="electrical_issues" name="issues" value="electrical_issues">
                                <label for="electrical_issues">Electrical Issues</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cleaning_needed" name="issues" value="cleaning_needed">
                                <label for="cleaning_needed">Cleaning Needed</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>📝 Additional Notes</h3>
                        <div class="form-row">
                            <textarea id="additionalNotes" placeholder="Enter any additional observations, repair recommendations, or special notes..."></textarea>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                        <button type="submit" class="btn btn-primary">Save Inspection</button>
                    </div>
                </form>
            </section>

            <!-- History Section -->
            <section id="historySection" class="section">
                <div id="historyContainer" class="history-container">
                    <div class="loading" id="historyLoading">
                        <div class="loading-spinner"></div>
                        Loading inspection history...
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="settings-overlay">
        <div class="settings-panel">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="close-settings" onclick="hideSettings()">✕</button>
            </div>
            
            <div class="settings-content">
                <div class="settings-section">
                    <h3>Account Information</h3>
                    <div class="user-info">
                        <div class="user-email" id="userEmail">Loading...</div>
                        <div class="user-status">✓ Account Active</div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Data Synchronization</h3>
                    <div class="user-info">
                        <div>Sync Status: <span id="settingsSyncStatus">Connected</span></div>
                        <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.5rem;">
                            Your inspection data automatically syncs across all your devices.
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Account Actions</h3>
                    <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="auth.js"></script>
    <script type="module" src="cloud-sync.js"></script>
    <script type="module" src="app.js"></script>
</body>
</html>

==================================================
### 2. REPLACE app.js with:

import { AuthManager } from './auth.js';
import { CloudSync } from './cloud-sync.js';

// Global variables
let authManager;
let cloudSync;
let currentUser = null;

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    try {
        // Initialize authentication
        authManager = new AuthManager();
        
        // Set up auth event listeners
        setupAuthEventListeners();
        
        // Listen for authentication state changes
        authManager.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await initializeMainApp();
                showMainApp();
            } else {
                currentUser = null;
                showAuthScreen();
            }
        });

        // Set up form submission
        setupFormSubmission();
        
        // Set today's date as default
        document.getElementById('inspectionDate').valueAsDate = new Date();
        
    } catch (error) {
        console.error('Failed to initialize app:', error);
        showError('Failed to initialize application. Please refresh the page.');
    }
}

function setupAuthEventListeners() {
    const authForm = document.getElementById('authForm');
    const authToggleBtn = document.getElementById('authToggleBtn');
    
    authForm.addEventListener('submit', handleAuthSubmit);
    authToggleBtn.addEventListener('click', toggleAuthMode);
}

async function handleAuthSubmit(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const isSignUp = document.getElementById('authSubmit').dataset.mode === 'signup';
    
    // Show loading state
    const submitBtn = document.getElementById('authSubmit');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<div class="loading-spinner"></div>Processing...';
    submitBtn.disabled = true;
    
    // Clear any previous errors
    hideAuthError();
    
    try {
        if (isSignUp) {
            await authManager.signUp(email, password);
        } else {
            await authManager.signIn(email, password);
        }
    } catch (error) {
        showAuthError(error.message);
    } finally {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function toggleAuthMode() {
    const submitBtn = document.getElementById('authSubmit');
    const toggleText = document.getElementById('authToggleText');
    const toggleBtn = document.getElementById('authToggleBtn');
    const buttonText = document.getElementById('authButtonText');
    
    if (submitBtn.dataset.mode === 'signup') {
        // Switch to sign in
        submitBtn.dataset.mode = 'signin';
        buttonText.textContent = 'Sign In';
        toggleText.textContent = "Don't have an account?";
        toggleBtn.textContent = 'Sign Up';
    } else {
        // Switch to sign up
        submitBtn.dataset.mode = 'signup';
        buttonText.textContent = 'Sign Up';
        toggleText.textContent = 'Already have an account?';
        toggleBtn.textContent = 'Sign In';
    }
}

function showAuthError(message) {
    const errorDiv = document.getElementById('authError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
}

function hideAuthError() {
    const errorDiv = document.getElementById('authError');
    errorDiv.classList.add('hidden');
}

function showAuthScreen() {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
}

function showMainApp() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    // Update user info in settings
    if (currentUser) {
        document.getElementById('userEmail').textContent = currentUser.email;
    }
}

async function initializeMainApp() {
    try {
        // Initialize cloud sync
        cloudSync = new CloudSync(currentUser.uid);
        
        // Set up real-time sync
        await cloudSync.setupRealtimeSync();
        
        // Set up sync status listeners
        setupSyncStatusListeners();
        
        // Load inspection history
        await loadInspectionHistory();
        
        // Set up auto-save for the inspection form
        setupAutoSave();
        
    } catch (error) {
        console.error('Failed to initialize main app:', error);
        updateSyncStatus('offline', 'Connection failed');
    }
}

function setupSyncStatusListeners() {
    // Listen for online/offline events
    window.addEventListener('online', () => {
        updateSyncStatus('syncing', 'Reconnecting...');
        cloudSync.processPendingOperations();
    });
    
    window.addEventListener('offline', () => {
        updateSyncStatus('offline', 'Offline mode');
    });
    
    // Set initial status
    if (navigator.onLine) {
        updateSyncStatus('connected', 'Connected');
    } else {
        updateSyncStatus('offline', 'Offline mode');
    }
}

function updateSyncStatus(status, text) {
    const indicator = document.getElementById('syncIndicator');
    const statusText = document.getElementById('syncStatus');
    const settingsStatus = document.getElementById('settingsSyncStatus');
    
    // Remove all status classes
    indicator.classList.remove('syncing', 'offline');
    
    // Add appropriate class
    if (status !== 'connected') {
        indicator.classList.add(status);
    }
    
    // Update text
    statusText.textContent = text;
    if (settingsStatus) {
        settingsStatus.textContent = text;
    }
}

function setupAutoSave() {
    const form = document.getElementById('inspectionForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    // Save form data as user types
    inputs.forEach(input => {
        input.addEventListener('input', debounce(() => {
            saveFormDraft();
        }, 1000));
    });
}

function saveFormDraft() {
    const formData = collectFormData();
    localStorage.setItem('inspectionDraft', JSON.stringify(formData));
}

function loadFormDraft() {
    const draft = localStorage.getItem('inspectionDraft');
    if (draft) {
        try {
            const data = JSON.parse(draft);
            populateForm(data);
        } catch (error) {
            console.error('Failed to load draft:', error);
        }
    }
}

function clearFormDraft() {
    localStorage.removeItem('inspectionDraft');
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function setupFormSubmission() {
    document.getElementById('inspectionForm').addEventListener('submit', handleFormSubmit);
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (!cloudSync) {
        showError('Cloud sync not initialized. Please try again.');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        // Show loading state
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;
        updateSyncStatus('syncing', 'Saving inspection...');
        
        // Collect form data
        const formData = collectFormData();
        
        // Add metadata
        const inspection = {
            ...formData,
            id: generateId(),
            createdAt: new Date().toISOString(),
            userId: currentUser.uid
        };
        
        // Save to cloud
        await cloudSync.saveInspection(inspection);
        
        // Clear the form and draft
        clearForm();
        clearFormDraft();
        
        // Show success message
        updateSyncStatus('connected', 'Inspection saved');
        showSuccess('Inspection saved successfully!');
        
        // Switch to history tab to show the new inspection
        showSection('history');
        
    } catch (error) {
        console.error('Failed to save inspection:', error);
        updateSyncStatus('offline', 'Save failed');
        showError('Failed to save inspection. Data saved locally and will sync when connection is restored.');
    } finally {
        // Reset button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
}

function collectFormData() {
    const form = document.getElementById('inspectionForm');
    const formData = new FormData(form);
    
    // Convert FormData to object
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (data[key]) {
            // Handle multiple values (like checkboxes)
            if (Array.isArray(data[key])) {
                data[key].push(value);
            } else {
                data[key] = [data[key], value];
            }
        } else {
            data[key] = value;
        }
    }
    
    // Get individual form fields
    data.propertyAddress = document.getElementById('propertyAddress').value;
    data.unitNumber = document.getElementById('unitNumber').value;
    data.inspectionType = document.getElementById('inspectionType').value;
    data.inspectorName = document.getElementById('inspectorName').value;
    data.inspectionDate = document.getElementById('inspectionDate').value;
    data.additionalNotes = document.getElementById('additionalNotes').value;
    
    // Get checked rooms
    data.rooms = Array.from(document.querySelectorAll('input[name="rooms"]:checked'))
        .map(cb => cb.value);
    
    // Get checked issues
    data.issues = Array.from(document.querySelectorAll('input[name="issues"]:checked'))
        .map(cb => cb.value);
    
    return data;
}

function populateForm(data) {
    // Set text inputs
    if (data.propertyAddress) document.getElementById('propertyAddress').value = data.propertyAddress;
    if (data.unitNumber) document.getElementById('unitNumber').value = data.unitNumber;
    if (data.inspectionType) document.getElementById('inspectionType').value = data.inspectionType;
    if (data.inspectorName) document.getElementById('inspectorName').value = data.inspectorName;
    if (data.inspectionDate) document.getElementById('inspectionDate').value = data.inspectionDate;
    if (data.additionalNotes) document.getElementById('additionalNotes').value = data.additionalNotes;
    
    // Set checkboxes
    if (data.rooms) {
        data.rooms.forEach(room => {
            const checkbox = document.getElementById(room);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    if (data.issues) {
        data.issues.forEach(issue => {
            const checkbox = document.getElementById(issue);
            if (checkbox) checkbox.checked = true;
        });
    }
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

async function loadInspectionHistory() {
    const container = document.getElementById('historyContainer');
    const loading = document.getElementById('historyLoading');
    
    try {
        loading.style.display = 'flex';
        
        if (!cloudSync) {
            throw new Error('Cloud sync not available');
        }
        
        const inspections = await cloudSync.getInspections();
        displayInspectionHistory(inspections);
        
    } catch (error) {
        console.error('Failed to load inspection history:', error);
        
        // Try to load from local storage as fallback
        const localInspections = getLocalInspections();
        if (localInspections.length > 0) {
            displayInspectionHistory(localInspections);
            updateSyncStatus('offline', 'Showing local data');
        } else {
            container.innerHTML = '<div class="no-history"><div class="icon">📋</div><p>No inspections found.<br>Create your first inspection to get started!</p></div>';
        }
    } finally {
        loading.style.display = 'none';
    }
}

function displayInspectionHistory(inspections) {
    const container = document.getElementById('historyContainer');
    
    if (!inspections || inspections.length === 0) {
        container.innerHTML = '<div class="no-history"><div class="icon">📋</div><p>No inspections found.<br>Create your first inspection to get started!</p></div>';
        return;
    }
    
    // Sort inspections by date (newest first)
    const sortedInspections = inspections.sort((a, b) => {
        const dateA = new Date(a.createdAt || a.inspectionDate);
        const dateB = new Date(b.createdAt || b.inspectionDate);
        return dateB - dateA;
    });
    
    const html = sortedInspections.map(inspection => createInspectionCard(inspection)).join('');
    container.innerHTML = html;
    
    // Add click handlers for expanding cards
    container.querySelectorAll('.inspection-header').forEach(header => {
        header.addEventListener('click', () => {
            const details = header.nextElementSibling;
            details.classList.toggle('show');
        });
    });
}

function createInspectionCard(inspection) {
    const date = new Date(inspection.createdAt || inspection.inspectionDate);
    const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const roomsList = inspection.rooms && inspection.rooms.length > 0 
        ? inspection.rooms.map(room => room.replace('_', ' ')).join(', ')
        : 'No rooms specified';
    
    const issuesList = inspection.issues && inspection.issues.length > 0
        ? inspection.issues.map(issue => `<li>${issue.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</li>`).join('')
        : '<li style="background: #d4edda; border-color: #c3e6cb; color: #155724;">No issues found</li>';
    
    return `
        <div class="inspection-card">
            <div class="inspection-header">
                <div>
                    <div class="inspection-title">
                        ${inspection.propertyAddress || 'No address specified'}
                        ${inspection.unitNumber ? ` - Unit ${inspection.unitNumber}` : ''}
                    </div>
                    <div class="inspection-date">${formattedDate}</div>
                </div>
            </div>
            <div class="inspection-details">
                <div class="detail-section">
                    <h4>Basic Information</h4>
                    <div class="detail-grid">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">${inspection.inspectionType || 'Not specified'}</span>
                        <span class="detail-label">Inspector:</span>
                        <span class="detail-value">${inspection.inspectorName || 'Not specified'}</span>
                        <span class="detail-label">Date:</span>
                        <span class="detail-value">${inspection.inspectionDate || 'Not specified'}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Rooms Inspected</h4>
                    <div class="detail-value">${roomsList}</div>
                </div>
                
                <div class="detail-section">
                    <h4>Issues Found</h4>
                    <ul class="issues-list">${issuesList}</ul>
                </div>
                
                ${inspection.additionalNotes ? `
                <div class="detail-section">
                    <h4>Additional Notes</h4>
                    <div class="detail-value">${inspection.additionalNotes}</div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

function getLocalInspections() {
    try {
        const stored = localStorage.getItem('inspectionHistory');
        return stored ? JSON.parse(stored) : [];
    } catch (error) {
        console.error('Failed to load local inspections:', error);
        return [];
    }
}

// Navigation functions
window.showSection = function(sectionName) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.nav-tab button').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected section
    document.getElementById(sectionName + 'Section').classList.add('active');
    document.getElementById(sectionName + 'Tab').classList.add('active');
    
    // Load history when history tab is selected
    if (sectionName === 'history') {
        loadInspectionHistory();
    }
};

// Form functions
window.clearForm = function() {
    document.getElementById('inspectionForm').reset();
    document.getElementById('inspectionDate').valueAsDate = new Date();
    clearFormDraft();
};

// Settings functions
window.showSettings = function() {
    document.getElementById('settingsOverlay').classList.add('show');
};

window.hideSettings = function() {
    document.getElementById('settingsOverlay').classList.remove('show');
};

window.signOut = async function() {
    try {
        await authManager.signOut();
        hideSettings();
    } catch (error) {
        console.error('Sign out failed:', error);
        showError('Failed to sign out. Please try again.');
    }
};

// Utility functions
function showSuccess(message) {
    // Simple success notification - you could enhance this with a toast system
    console.log('SUCCESS:', message);
}

function showError(message) {
    // Simple error notification - you could enhance this with a toast system
    console.error('ERROR:', message);
    alert(message); // Temporary - replace with better UI
}

// Service worker registration for PWA functionality
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// Handle app install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    deferredPrompt = e;
    // You could show an install button here
});

// Listen for real-time updates from CloudSync
document.addEventListener('inspectionAdded', (event) => {
    const inspection = event.detail;
    console.log('New inspection added:', inspection);
    
    // Refresh history if we're on the history tab
    const historySection = document.getElementById('historySection');
    if (historySection.classList.contains('active')) {
        loadInspectionHistory();
    }
    
    updateSyncStatus('connected', 'Data synced');
});

document.addEventListener('inspectionUpdated', (event) => {
    console.log('Inspection updated:', event.detail);
    
    // Refresh history if we're on the history tab
    const historySection = document.getElementById('historySection');
    if (historySection.classList.contains('active')) {
        loadInspectionHistory();
    }
    
    updateSyncStatus('connected', 'Data synced');
});
